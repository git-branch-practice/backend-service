name: CI - Build & Upload to GCS (DEV)

on:
  push:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. ìë°” í™˜ê²½ ì„¸íŒ…
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 2. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 3. ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ìƒëµ)
      - name: Build without tests
        run: ./gradlew clean bootJar -x test

      # 4. ì—…ë¡œë“œí•  íŒŒì¼ëª… ìƒì„± (timestamp)
      - name: Generate datetime tag
        id: date
        run: |
          tag=$(date +'%Y%m%d-%H%M')
          echo "tag=$tag" >> $GITHUB_OUTPUT

      # 5. GCP ì¸ì¦
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 6. gcloud ë° gsutil ì„¤ì •
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      # 7. Jar ê²½ë¡œ ë° íŒŒì¼ëª… ì¶”ì¶œ
      - name: Get JAR file name
        id: jar
        run: |
          jar_path=$(ls build/libs/*SNAPSHOT.jar | head -n1)
          jar_name=$(basename "$jar_path")
          echo "JAR_PATH=$jar_path" >> $GITHUB_OUTPUT
          echo "JAR_NAME=$jar_name" >> $GITHUB_OUTPUT

      # 8. GCS - ë²„ì „ë³„ JAR ì—…ë¡œë“œ
      - name: Upload versioned JAR to GCS
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: ${{ steps.jar.outputs.JAR_PATH }}
          destination: 6-nemo-bucket/v1/backend-deploy/dev/${{ steps.date.outputs.tag }}.jar/${{ steps.jar.outputs.JAR_NAME }}

      # 9. GCS - latest/previous.jar ê´€ë¦¬
      - name: Copy latest to previous, then upload new latest
        run: |
          if gsutil ls gs://6-nemo-bucket/v1/backend-deploy/dev/latest.jar; then
            echo "ğŸ“¦ ë°±ì—…: latest.jar â†’ previous.jar"
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/latest.jar \
                      gs://6-nemo-bucket/v1/backend-deploy/dev/previous.jar
          else
            echo "âš ï¸  latest.jar ì—†ìŒ â†’ ë°±ì—… ìƒëµ"
          fi

          echo "â¬†ï¸ ìƒˆ latest.jar ì—…ë¡œë“œ"
          gsutil cp ${{ steps.jar.outputs.JAR_PATH }} \
                    gs://6-nemo-bucket/v1/backend-deploy/dev/latest.jar

      # 10. GCS - ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ
      - name: Upload deploy scripts to GCS
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: deploy/
          destination: 6-nemo-bucket/v1/backend-deploy/dev/

  cd-deploy:
    name: Trigger CD after successful CI
    needs: build
    if: startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/ci-cd/')
    uses: ./.github/workflows/dev-cd.yaml
    secrets:
      DEV_HOST: ${{ secrets.DEV_HOST }}
      DEV_USER: ${{ secrets.DEV_USER }}
      DEV_SSH_KEY: ${{ secrets.DEV_SSH_KEY }}
