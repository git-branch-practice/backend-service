name: CD - Deploy to Server (DEV)

on:
  workflow_call:
    inputs:
      JAR_TIMESTAMP:
        required: true
        type: string
    secrets:
      DEV_HOST:
        required: true
      DEV_USER:
        required: true
      DEV_SSH_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH and deploy from GCS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: 22
          script: |
            set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ

            echo "âœ… SSH ì ‘ì† ì„±ê³µ"
            mkdir -p ~/backend && cd ~/backend

            VERSION_TAG="${{ inputs.JAR_TIMESTAMP }}"
            JAR_NAME="${VERSION_TAG}.jar"
            echo "ğŸ“¦ ë°°í¬í•  ë²„ì „: $JAR_NAME"

            # ê¸°ì¡´ JAR ë°±ì—…
            if [ -f latest.jar ]; then
              echo "ğŸ“ ê¸°ì¡´ latest.jar â†’ previous.jar ë°±ì—…"
              mv latest.jar previous.jar
            else
              echo "ğŸ†• ìµœì´ˆ ë°°í¬ - ì´ì „ ë²„ì „ ì—†ìŒ"
            fi

            echo "â¬‡ï¸ JAR ë‹¤ìš´ë¡œë“œ"
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/${JAR_NAME} latest.jar

            echo "â¬‡ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ë° í—¬ìŠ¤ì²´í¬ ë‹¤ìš´ë¡œë“œ"
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/deploy/dev-deploy.sh .
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/deploy/validate.sh .

            echo "ğŸ” ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬"
            chmod +x dev-deploy.sh validate.sh

            echo "ğŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
            ./dev-deploy.sh