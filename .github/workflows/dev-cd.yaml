name: CD - Deploy to Server (DEV)

on:
  workflow_call:
    inputs:
      JAR_TIMESTAMP:
        required: true
        type: string
    secrets:
      DEV_HOST:
        required: true
      DEV_USER:
        required: true
      DEV_SSH_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH and deploy from GCS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: 22
          script: |
            set -e  # 오류 발생 시 즉시 종료

            echo "✅ SSH 접속 성공"
            mkdir -p ~/backend && cd ~/backend

            VERSION_TAG="${{ inputs.JAR_TIMESTAMP }}"
            JAR_NAME="${VERSION_TAG}.jar"
            echo "📦 배포할 버전: $JAR_NAME"

            # 기존 JAR 백업
            if [ -f latest.jar ]; then
              echo "📁 기존 latest.jar → previous.jar 백업"
              mv latest.jar previous.jar
            else
              echo "🆕 최초 배포 - 이전 버전 없음"
            fi

            echo "⬇️ JAR 다운로드"
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/${JAR_NAME} latest.jar

            echo "⬇️ 배포 스크립트 및 헬스체크 다운로드"
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/deploy/dev-deploy.sh .
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/deploy/validate.sh .

            echo "🔐 실행 권한 부여"
            chmod +x dev-deploy.sh validate.sh

            echo "🚀 배포 스크립트 실행"
            ./dev-deploy.sh