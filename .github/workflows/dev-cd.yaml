name: CD - Deploy to Server (DEV)

on:
  workflow_call:
    secrets:
      DEV_HOST:
        required: true
      DEV_USER:
        required: true
      DEV_SSH_KEY:
        required: true

jobs:
  deploy:
    # CI 성공한 경우에만 실행
    runs-on: ubuntu-latest

    steps:
      # SSH로 개발 서버에 접속 후 GCS에서 배포 스크립트 및 JAR 다운로드 후 실행
      - name: SSH and deploy from GCS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_HOST }}            # GCP 개발 서버 IP
          username: ${{ secrets.DEV_USER }}        # SSH 사용자명
          key: ${{ secrets.DEV_SSH_KEY }}          # SSH 키 (시크릿 + BEGIN ~) + .pub은 서버 authorized_keys에 등록
          port: 22
          script: |
            echo "SSH 접속 성공, GCS에서 최신 스크립트 및 JAR 다운로드 시작"
            
            # 1. 디렉토리 준비 및 이동
            mkdir -p ~/backend && cd backend
            
            # 2. JAR 및 스크립트 다운로드
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/latest.jar .
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/previous.jar . || true
            gsutil cp gs://6-nemo-bucket/v1/backend-deploy/dev/deploy/deploy.sh .
            
            # 3. 실행 권한 부여
            chmod +x deploy.sh rollback.sh validate.sh
            
            # 4. 배포 실행
            ./deploy.sh
            
            

            
            



